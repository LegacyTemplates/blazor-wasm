@inherits AppComponentBase

<form @onsubmit="_ => OnSubmit()" class=@CssUtils.ClassNames("relative shadow rounded p-4", @class)>
<CascadingValue Value=@apiResult.ErrorStatus>
    <button type="button" class="close" @onclick="close"><i></i></button>

    <h1 class="fs-4 text-secondary text-center">
        Edit Booking
    </h1>

    <ErrorSummary VisibleFields=@(new[]{ 
        nameof(request.Name), nameof(request.RoomType), nameof(request.RoomNumber), nameof(request.BookingStartDate), 
        nameof(request.BookingEndDate), nameof(request.Cost), nameof(request.Notes),
    }) />
    <ErrorSummary ExplicitStatus=@deleteApiResult.ErrorStatus />

    <div class="mb-3 form-floating">
        <TextInput @bind-Value="request.Name" required placeholder="Name for this booking" />
    </div>

    <div class="mb-3 form-floating">
        <SelectInput @bind-Value="request.RoomType" Options=@(Enum.GetValues<RoomType>().Cast<RoomType?>()) /> 
    </div>

    <div class="mb-3 form-floating">
        <TextInput type="number" @bind-Value="request.RoomNumber" min="0" required />
    </div>

    <div class="mb-3 form-floating">
        <DateTimeInput @bind-Value="request.BookingStartDate" required />
    </div>

    <div class="mb-3 form-floating">
        <DateTimeInput @bind-Value="request.BookingEndDate" />
    </div>

    <div class="mb-3 form-floating">
        <TextInput type="number" @bind-Value="request.Cost" min="0" required />
    </div>
    
    <div class="mb-3 form-floating">
        <TextAreaInput @bind-Value="request.Notes" placeholder="Notes about this booking" style="height:6rem" />
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <div>
            <input type="checkbox" @bind=deleteConfirmed id="deleteConfirmed" />
            <label for="deleteConfirmed">confirm</label>
            <span class=@ClassNames("ms-2 btn btn-danger", deleteConfirmed ? "" : "disabled") @onclick="delete">Delete</span>
        </div>

        <div class="d-flex-fill">
            <SrcLink href="https://github.com/NetCoreTemplates/blazor-wasm/blob/master/MyApp.Client/Pages/BookingsCrud/Edit.razor" 
                     IconSrc="/img/blazor.svg" class="mt-2" />
        </div>

        <div>
            <button type="submit" class="btn btn-primary">Update Booking</button>
        </div>
    </div>

</CascadingValue>
</form>


@if (apiResult.IsSuccess) {
    <h3 class="text-success mt-4">@apiResult.Response!.Id</h3>
}

@code {
    [Parameter] public int? Id { get; set; }
    [Parameter] public EventCallback<IdResponse> done { get; set; }
    [Parameter] public string? @class { get; set; }

    bool deleteConfirmed = false;

    UpdateBooking request = new();

    async Task refresh()
    {
        var selectApiResult = await ApiAsync(new QueryBookings { Id = Id });
        if (selectApiResult.IsError)
        {
            apiResult = ApiResult.CreateError<IdResponse>(selectApiResult.ErrorStatus!);
            return;
        }

        if (selectApiResult.Response!.Results.Count == 0)
        {
            apiResult = ApiResult.CreateError<IdResponse>($"Booking #{Id} does not exist");
            return;
        }

        var booking = selectApiResult.Response!.Results[0];
        request = new UpdateBooking
        {
            Id = booking.Id,
            Name = booking.Name,
            RoomType = booking.RoomType,
            RoomNumber = booking.RoomNumber,
            BookingStartDate = booking.BookingStartDate,
            BookingEndDate = booking.BookingEndDate,
            Cost = booking.Cost,
            Notes = booking.Notes,
        };
    }

    protected override async Task OnInitializedAsync() => await refresh();

    async Task close() => await done.InvokeAsync(null);

    ApiResult<IdResponse> apiResult = new();

    async Task OnSubmit()
    {
        apiResult = await ApiAsync(request);

        if (apiResult.IsSuccess)
        {
            await done.InvokeAsync(apiResult.Response!);
        }
    }

    ApiResult<EmptyResponse> deleteApiResult = new();

    async Task delete()
    {
        if (!deleteConfirmed)
            return;

        deleteApiResult = await ApiAsync(new DeleteBooking { Id = Id ?? 0 });

        if (deleteApiResult.IsSuccess)
            await close();
    }
}
